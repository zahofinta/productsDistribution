
@model  ProductsDistribution.Models.InputModels.AnnouncementInfo
@*<head>
        <link href="@Url.Content("~/Content/Themes/base/jquery-ui.css")" rel="stylesheet" type="text/css" />

    </head>

    <style>
        .custom-combobox {
            position: relative;
            display: inline-block;
        }

        .custom-combobox-toggle {
            position: absolute;
            top: 0;
            bottom: 0;
            margin-left: -1px;
            padding: 0;
            /* support: IE7 */
            *height: 1.7em;
            *top: 0.1em;
        }

        .custom-combobox-input {
            margin: 0;
            padding: 0.3em;
        }
    </style>*@



@using (Html.BeginForm(null,null,FormMethod.Post,new { name = "AnnouncementToPost", id="AnnouncementToPost"}))
{

    <button class="add-announcement" onclick="AddTextBox()">
        Добави
    </button>
    <div id="announcementForm">

        <table id="announcements">
            <thead>
                <tr></tr>
                @*<tr>
                        <th>Дата на пристигане на доставката</th>
                        <th>Производител</th>
                        <th>Продукт</th>
                        <th>Цена</th>
                        <th>Максимално количество за доставка</th>

                        <th></th>
                    </tr>*@
            </thead>
            <tbody id="an">



               @* @Html.Partial("AnnouncementInfo") *@
           
              @Html.EditorForModel() 
                 

               
            </tbody>


        </table>

    </div>



        <div id="forms">



        </div>




        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Изпрати" class="btn btn-default" id="submitButton" />
            </div>
        </div>
}


@section scripts
{

    @*<script src="@Url.Content("~/Scripts/jquery.autocomplete.js")"></script>
        <script src="@Url.Content("~/Scripts/jquery-ui.js")"></script>
        <script src="@Url.Content("~/Scripts/GenerateComboBox.js")"></script>*@




    <script>
        $(document.body).on("click", "a.delete-announcement", function () {
          
            $(this).parents("#announcementForm:first").remove();
            $(this).prev('input').val('true');
            return false;
        });

    </script>
    <script>

        $('.add-announcement').click(function () {
            // var index = parseInt($('.form-horizontal:last').data('rownum')) + 1;

            $.ajax({
                url: "/Announcement/AddNewAnnouncement",
                type: "GET",
                cache: false,
                success: function (html) {


                    // var content = $('#announcement').html();
                    //  $('#forms').append(html);


                }
            });
            return false;
        });

    </script>

    <script type="text/javascript">

        function GetDynamicTextBox() {
            //var uniqueId = 0;
            var div = $("<div />");
            //uniqueId++;
           
           
            var textBox = $('#announcementForm').html();
           
            div.append(textBox);

            var button = $("<input />").attr("type", "button").attr("value", "Remove");
            button.attr("onclick", "RemoveTextBox(this)");
            div.append(button);




            return div;
        }
        function AddTextBox() {
            var div = GetDynamicTextBox();
            $("#forms").append(div);


            //$.ajax({
            //    url: "/Announcement/LoadProducerNamesByUserId",
            //    type: "post",
            //    success: function (data) {

            //        var producerNames = "<select id='ddlProducerNames'>";

            //        producerNames = producerNames + '<option value=""></option>';
            //        for (var i = 0; i < data.length; i++) {
            //            producerNames = producerNames + '<option value=' + data[i] + '>' + data[i] + '</option>';
            //        }
            //        producerNames = producerNames + '</select>';

            //        $('#combobox').html(producerNames);




            //    }

            //});


        }

        function RemoveTextBox(button) {
            $(button).parent().remove();
        }




    </script>

    <script>
        $(document).ready(function () {


            //$('.ddlProducer').change(function () {
            //    $.ajax({
            //        type: "post",
            //        url: "/Announcement/LoadProductNamesByProducerNameAndUserId",
            //        data: { producerName: $('.ddlProducer').val() },
            //        datatype: "json",
            //        traditional: true,
            //        success: function (data) {

            //            var products = "<select id='ddlProducts'>";

            //            products = products + '<option value=""></option>';
            //            for (var i = 0; i < data.length; i++) {
            //                products = products + '<option value=' + data[i] + '>' + data[i] + '</option>';
            //            }
            //            products = products + '</select>';

            //            $('.ddlProducer').closest('.announcementForm').find('.ddlProduct').html(products);
            //          //  $('.ddlProducer').closest('.announcementForm').find('.ddlProduct').html(products);
            //            //nai-blizkiq vtori dropdown do izbraniq purvi
            //        }


            //    });
                

            //});

            $(document).on("change", ".ddlProducer", function (e) {
                var _this = $(this);

                //// to do  :Change below url variable value as needed for your code
                //var urlToGetSecondDropDownData = "/Announcement/LoadProductNamesByProducerNameAndUserId";

                //$.post(urlToGetSecondDropDownData,
                //    function (data) {
                //        var items = "";
                //        $.each(data,
                //            function (index, item) {
                //                items += "<option value='" + item.Value + "'>"
                //                    + item.Text + "</option>";
                //            });
                //        _this.closest(".announcementForm")                // Get the same table row
                //            .find(".ddlProduct")  // Find the second dropdown
                //            .html(items);                 // update the content of it

                //    }); // var v = _this.val();


                      $.ajax({
                    type: "post",
                    url: "/Announcement/LoadProductNamesByProducerNameAndUserId",
                    data: { producerName: $(this).val() },
                    datatype: "json",
                    traditional: true,
                    success: function (data) {

                        var products = "<select id='ddlProducts'>";

                        products = products + '<option value=""></option>';
                        for (var i = 0; i < data.length; i++) {
                            products = products + '<option value=' + data[i] + '>' + data[i] + '</option>';
                        }
                        products = products + '</select>';
                        _this.closest('.announcementForm').find('.ddlProduct').html(products);

                      //  $('.ddlProducer').closest('.announcementForm').find('.ddlProduct').html(products);
                        //nai-blizkiq vtori dropdown do izbraniq purvi
                    }


                });



            });

           


        });

    </script>

    <script>



      



        $("#submitButton").click(function () {

            var items = new Array();
            //var arrive_date = $('#arrive_date').val();
            //var producer = $('#combobox').val();
            //var product = $('.ddlProduct').val();
            //var quantity = $('#quantity').val();
            //var price = $('#price').val();


            //var item = {
            //    arrive_date: arrive_date,
            //    quantity: quantity,
            //    price: price,
            //    selected_producerName: producer,
            //    selected_productName: product

            //};
            //items.push(item);
            //var i = 0;
            $('.announcementForm').each(function (index) {

              //  i++;
              //  $(this).attr("id", "announcementInfoForm" + i);

                var arrive_date = $(this).find('#arrive_date').val();
                var producer = $(this).find('#combobox').val();
                var product = $(this).find('#productCombobox').val()
                var quantity = $(this).find('#quantity').val();
                var price = $(this).find('#price').val();

                var item = {
                    arrive_date: arrive_date,
                    quantity: quantity,
                    price: price,
                    selected_producerName: producer,
                    selected_productName: product

                };
                items.push(item);

            });
            $.ajax({
                url: '/Announcement/AddNewAnnouncement',
                type: 'POST',
                dataType: 'json',
                data: { inputModel:  items  },
                
                async: false,
                success: function (data) {
                    console.log(data);
                    alert(data);
                },
                error: function (xhr, textStatus, exceptionThrown) { alert(JSON.parse(xhr.responseText)); }
            });
        });

    </script>

}