
@model  ProductsDistribution.Models.InputModels.AnnouncementInfo
@*<head>
        <link href="@Url.Content("~/Content/Themes/base/jquery-ui.css")" rel="stylesheet" type="text/css" />

    </head>

    <style>
        .custom-combobox {
            position: relative;
            display: inline-block;
        }

        .custom-combobox-toggle {
            position: absolute;
            top: 0;
            bottom: 0;
            margin-left: -1px;
            padding: 0;
            /* support: IE7 */
            *height: 1.7em;
            *top: 0.1em;
        }

        .custom-combobox-input {
            margin: 0;
            padding: 0.3em;
        }
    </style>*@
<button class="add-announcement" onclick="AddTextBox()">
    Добави продукт
</button>


@using (Html.BeginForm(null, null, FormMethod.Post, new { name = "AnnouncementToPost", id = "AnnouncementToPost" }))
{

    @Html.AntiForgeryToken()
    HtmlHelper.UnobtrusiveJavaScriptEnabled = false;

    <div class="form-group">
        @Html.LabelFor(model => model.arrive_date, htmlAttributes: new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.arrive_date, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.arrive_date, "", new { @class = "text-danger" })
        </div>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.title, htmlAttributes: new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.title, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.title, "", new { @class = "text-danger" })
        </div>
    </div>

    <div id="announcementForm">

        <table id="announcements">
            <thead>
                <tr></tr>
                @*<tr>
                        <th>Дата на пристигане на доставката</th>
                        <th>Производител</th>
                        <th>Продукт</th>
                        <th>Цена</th>
                        <th>Максимално количество за доставка</th>

                        <th></th>
                    </tr>*@
            </thead>
            <tbody id="an">


             @Html.Partial("EditorTemplates/AnnouncementInfo")
              @*  @Html.EditorForModel() *@



            </tbody>


        </table>

    </div>



    <div id="forms">



    </div>


    /* onclick='window.location = "@Url.Action("Index", "Home")"' */

    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <input type="submit" value="Изпрати" class="btn btn-default" id="submitButton"  />
        </div>
    </div>
}


@section scripts
{

@Scripts.Render("~/bundles/jqueryval")
@Scripts.Render("~/bundles/custom-validator")

@*@<script src="@Url.Content("~/Scripts/jquery.autocomplete.js")"></script>
        <script src="@Url.Content("~/Scripts/jquery-ui.js")"></script>
        <script src="@Url.Content("~/Scripts/GenerateComboBox.js")"></script> *@

<script src="@Url.Content("~/Scripts/script-custom-validator.js")"></script>



    @*<script>
        $(document.body).on("click", "a.delete-announcement", function () {

            $(this).parents("#announcementForm:first").remove();
            $(this).prev('input').val('true');
            return false;
        });

    </script>*@
 
        





    <script>

        //$('.add-announcement').click(function () {

        //    $.ajax({
        //        url: "/Announcement/AddNewAnnouncement",
        //        type: "GET",
        //        cache: false,
        //        success: function (html) {

        //            // $("#forms").append(div);
        //            // var content = $('#announcement').html();
        //            //  $('#forms').append(html);


        //        }
        //    });
        //    return false;
        //});

    </script>

    <script type="text/javascript">

        function GetDynamicTextBox() {
            //var uniqueId = 0;
            var div = $("<div />");
            //uniqueId++;
            //$('#announcementForm').find('.text-danger').empty();
            var textBox = $('#announcementForm').html();
            
            /*
            var textBox = jQuery.validator.format($.trim($("#announcementForm").html()));

            $('#comobox,#productCombobox,#title,#arrive_date,#quantity,#price').each(function () {
                $(this).rules("add", {
                    required: true
                });
            });

            $("#AnnouncementToPost").validate({
                rules: {
                    title: "required"
                   
                }
            }); 
            */

            div.append(textBox);
            

            var button = $("<input />").attr("type", "button").attr("value", "Премахни продукт");
            button.attr("onclick", "RemoveTextBox(this)");
            div.append(button);


            return div;
        }
        function AddTextBox() {
            var div = GetDynamicTextBox();
            // div.removeClass('.text-danger');
          //  $(div).remove('.text-danger');
            

            $("#forms").append(div);
           // $("#forms").find('.text-danger').empty();

        }

        function RemoveTextBox(button) {
            $(button).parent().remove();
        }




    </script>

    <script>
        $(document).ready(function () {




            $(document).on("change", ".ddlProducer", function (e) {
                var _this = $(this);




                $.ajax({
                    type: "post",
                    url: "/Announcement/LoadProductNamesByProducerNameAndUserId",
                    data: { producerName: $(this).val() },
                    datatype: "json",
                    traditional: true,
                    success: function (data) {

                        var products = "<select id='ddlProducts'>";

                        products = products + '<option value=""></option>';
                        for (var i = 0; i < data.length; i++) {
                            products = products + '<option value=' + data[i] + '>' + data[i] + '</option>';
                        }
                        products = products + '</select>';
                        _this.closest('.announcementForm').find('.ddlProduct').html(products);

                        //  $('.ddlProducer').closest('.announcementForm').find('.ddlProduct').html(products);
                        //nai-blizkiq vtori dropdown do izbraniq purvi
                    }


                });



            });




        });

    </script>

    <script>
        $(document).ready(function () {

           // $.validator.unobtrusive.parse("#AnnouncementToPost");

            function GetValuesFromForm() {
                var items = new Array();

                $('.announcementForm').each(function (index) {

                    //var arrive_date = $(this).find('#arrive_date').val();
                    //var producer = $(this).find('#combobox').attr('value');
                    var producer = $(this).find('#combobox option:selected').text();
                    //  var product = $(this).find('#productCombobox').attr('value');
                    var product = $(this).find('#productCombobox option:selected').text();
                    var quantity = $(this).find('#quantity').val();
                    var price = $(this).find('#price').val();

                    var item = {

                        quantity: quantity,
                        price: price,
                        selected_producerName: producer,
                        selected_productName: product

                    };
                    items.push(item);

                });

                return items;
            }



            $("#AnnouncementToPost").submit(function (e) {

                e.preventDefault();
               // e.stopImmediatePropagation();
                var items = GetValuesFromForm();


                var announcementInfoModel = {
                    arrive_date: $('#arrive_date').val(),
                    title: $('#title').val(),
                    remainingProducts: items

                };
                $.ajax({
                    url: '/Announcement/AddNewAnnouncement',
                    type: 'POST',
                    dataType: 'json',
                    data: { inputModel: announcementInfoModel },
                    async: false,
                    success: function (data) {
                        // console.log(data);
                        //   alert(data);


                    },
                    error: function (xhr, textStatus, exceptionThrown) { alert(JSON.parse(xhr.responseText)); }
                });


            });



            /*
            $("#submitButton").click(function (e) {
                  e.preventDefault();
                 // e.stopImmediatePropagation();
                  var items = GetValuesFromForm();


                  var announcementInfoModel = {
                      arrive_date: $('#arrive_date').val(),
                      title: $('#title').val(),
                      remainingProducts: items

                  };
                $.ajax({
                    url: '/Announcement/AddNewAnnouncement',
                    type: 'POST',
                    dataType: 'json',
                    data: { inputModel: announcementInfoModel },
                    async: false,
                    success: function (data) {
                        // console.log(data);
                        //   alert(data);


                    },
                    error: function (xhr, textStatus, exceptionThrown) { alert(JSON.parse(xhr.responseText)); }
                  });

            });
            */

});

    </script>

}